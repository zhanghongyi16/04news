<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>新闻页面</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --brand: #0ea5e9;
      --brand-contrast: #ffffff;
      --bg: #f7f7f8;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --link: #2563eb;
      --border: #e5e7eb;
      --radius: 12px;
      --container: 860px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      line-height: 1.65;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    a { color: var(--link); }

    /* 顶部栏与布局 */
    .topbar {
      position: sticky; top: 0; z-index: 50;
      background: var(--brand); color: var(--brand-contrast);
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .topbar-inner {
      max-width: var(--container); margin: 0 auto; padding: 12px 14px;
      display: flex; align-items: center; gap: 12px; justify-content: space-between;
    }
    .left-group { display: flex; align-items: center; gap: 12px; }
    .title { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 0.2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tabs { display: flex; gap: 6px; }
    .tab {
      appearance: none; border: 1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.08); color: var(--brand-contrast);
      padding: 6px 10px; border-radius: 10px; font-size: 13px; cursor: pointer;
      transition: all .2s ease; backdrop-filter: saturate(1.2) blur(2px);
    }
    .tab:hover { background: rgba(255,255,255,0.16); border-color: rgba(255,255,255,0.55); }
    .tab.active { background: rgba(255,255,255,0.24); border-color: rgba(255,255,255,0.8); }

    .controls { display: flex; gap: 8px; align-items: center; }
    .btn {
      appearance: none; border: 1px solid rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.1); color: var(--brand-contrast);
      padding: 6px 10px; border-radius: 10px; font-size: 14px; cursor: pointer;
      transition: all .2s ease; backdrop-filter: saturate(1.2) blur(2px);
    }
    .btn:hover { background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.6); }

    .container { max-width: var(--container); margin: 12px auto; padding: 0 12px 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.04); overflow: hidden; }
    .card-header { padding: 10px 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .card-header h2 { margin: 0; font-size: 16px; color: var(--text); }
    .status { font-size: 13px; color: var(--muted); }
    .content { padding: 10px 12px; color: var(--text); }

    .error {
      color: #b91c1c; background: #fee2e2; border: 1px solid #fecaca;
      padding: 10px 12px; border-radius: 10px;
    }

    /* Markdown 紧凑样式（主页面） */
    .markdown-body { line-height: 1.6; }
    .markdown-body p { margin: 0.25em 0; }
    .markdown-body h1, .markdown-body h2,
    .markdown-body h3, .markdown-body h4,
    .markdown-body h5, .markdown-body h6 { margin: 0.5em 0 0.25em; }
    .markdown-body ul, .markdown-body ol { margin: 0.25em 0; padding-left: 1.1em; }
    .markdown-body li { margin: 0.1em 0; }
    .markdown-body blockquote {
      margin: 0.4em 0; padding: .4em .6em; color: var(--muted);
      border-left: 4px solid var(--border); background: rgba(0,0,0,0.02);
    }
    .markdown-body code { background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .markdown-body pre { margin: 0.4em 0; }
    .markdown-body pre code {
      display: block; padding: 10px; border-radius: 8px; overflow: auto;
      background: #0f172a; color: #e5e7eb;
    }
    .markdown-body table { border-collapse: collapse; width: 100%; margin: 0.4em 0; }
    .markdown-body th, .markdown-body td { border: 1px solid var(--border); padding: .4em .5em; }
    .markdown-body hr { border: none; border-top: 1px solid var(--border); margin: 0.6em 0; }

    /* 提及次数页面样式 */
    .mentions-list { list-style: none; padding: 0; margin: 0; }
    .mentions-item {
      display: flex; align-items: center; justify-content: space-between;
      gap: 8px; padding: 8px 10px; border-bottom: 1px dashed var(--border);
    }
    .mentions-item:last-child { border-bottom: none; }
    .name { font-weight: 600; }
    .title-badge {
      font-size: 12px; color: var(--text);
      background: rgba(0,0,0,0.04); border: 1px solid var(--border);
      padding: 2px 8px; border-radius: 999px; white-space: nowrap;
    }

    @media (prefers-color-scheme: dark) {
      :root { --bg: #0b0e12; --card: #0f141a; --text: #e5e7eb; --muted: #9ca3af; --border: #1f2937; --link: #60a5fa; }
      .btn { border-color: rgba(255,255,255,0.2); }
      .btn:hover { border-color: rgba(255,255,255,0.4); }
      .tab { border-color: rgba(255,255,255,0.25); }
      .tab.active { background: rgba(255,255,255,0.32); border-color: rgba(255,255,255,0.7); }
      .error { color: #fecaca; background: #7f1d1d; border-color: #991b1b; }
      .markdown-body blockquote { background: rgba(255,255,255,0.04); }
      .markdown-body pre code { background: #0b1220; }
      .title-badge { background: rgba(255,255,255,0.06); }
    }

    /* 可选：禁止图片拖拽（保留选中与点击） */
    img {
      -webkit-user-drag: none;
      user-drag: none;
    }
  </style>

  <!-- CDN：marked 用于 Markdown 渲染，DOMPurify 用于安全清理 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="left-group">
        <h1 class="title" id="pageTitle">五(4)班新闻</h1>
        <nav class="tabs" aria-label="页面切换">
          <button class="tab active" id="tabHome" type="button">新闻</button>
          <button class="tab" id="tabMentions" type="button">提及次数</button>
        </nav>
      </div>
      <div class="controls">
        <button class="btn" id="refreshBtn" title="重新加载当前页面内容">刷新内容</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="card-header">
        <h2 id="sectionTitle">最新新闻</h2>
        <div class="status" id="statusText">正在加载...</div>
      </div>
      <!-- 主页面（Markdown） -->
      <div class="content markdown-body" id="newsContent" aria-live="polite"></div>
      <!-- 提及次数页面 -->
      <div class="content" id="mentionsContent" aria-live="polite" style="display:none;"></div>
    </section>
  </main>

  <script>
    // ===== 主题与标题（可改） =====
    const THEME = {
      brand: '#0ea5e9',          // 顶部主色
      brandContrast: '#ffffff',  // 顶部文字颜色
      title: '新闻聚合',           // 顶部标题
      containerMaxWidth: '860px',// 内容最大宽度
      fontFamily: undefined       // 自定义字体族（可留空）
    };

    // 远程地址（可改）
    const NEWS_URL = 'https://raw.githubusercontent.com/zhanghongyi16/2z1h0y4nf/refs/heads/main/z2h1y0n4.txt';
    const MENTIONS_URL = 'https://raw.githubusercontent.com/zhanghongyi16/2z1h0y4nf/refs/heads/main/tijicishu04.txt';

    // 当前视图：'home' 或 'mentions'
    let currentView = 'home';

    function applyTheme() {
      const root = document.documentElement;
      if (THEME.brand) root.style.setProperty('--brand', THEME.brand);
      if (THEME.brandContrast) root.style.setProperty('--brand-contrast', THEME.brandContrast);
      if (THEME.containerMaxWidth) root.style.setProperty('--container', THEME.containerMaxWidth);
      if (THEME.fontFamily) root.style.setProperty('--font', THEME.fontFamily);
      if (THEME.title) document.getElementById('pageTitle').textContent = THEME.title;
      document.title = THEME.title || document.title;
    }

    // Markdown 渲染（带安全清理）
    function renderMarkdown(mdText) {
      marked.setOptions({
        gfm: true,
        breaks: true // 单换行 => <br>，如不需要可改为 false
      });
      const rawHtml = marked.parse(mdText || '');
      return DOMPurify.sanitize(rawHtml);
    }

    // UI：切换视图
    function switchView(view) {
      currentView = view;
      const newsEl = document.getElementById('newsContent');
      const mentionsEl = document.getElementById('mentionsContent');
      const tabHome = document.getElementById('tabHome');
      const tabMentions = document.getElementById('tabMentions');
      const sectionTitle = document.getElementById('sectionTitle');
      const statusEl = document.getElementById('statusText');

      // Tab 激活态
      tabHome.classList.toggle('active', view === 'home');
      tabMentions.classList.toggle('active', view === 'mentions');

      // 显示/隐藏内容区域
      if (view === 'home') {
        sectionTitle.textContent = '最新资讯';
        newsEl.style.display = '';
        mentionsEl.style.display = 'none';
      } else {
        sectionTitle.textContent = '提及次数';
        newsEl.style.display = 'none';
        mentionsEl.style.display = '';
      }

      // 状态重置并加载对应内容
      statusEl.textContent = '正在加载...';
      if (view === 'home') {
        fetchNews(NEWS_URL);
      } else {
        fetchMentions(MENTIONS_URL);
      }
    }

    // 主页面：获取并渲染 Markdown
    async function fetchNews(url) {
      const statusEl = document.getElementById('statusText');
      const contentEl = document.getElementById('newsContent');

      statusEl.textContent = '正在加载...';
      contentEl.innerHTML = '';

      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('网络响应异常：' + res.status + ' ' + res.statusText);
        let text = await res.text();

        // 规范换行，去掉尾随空白，减少意外空隙
        text = text.replace(/\r\n/g, '\n').trimEnd();

        const html = renderMarkdown(text);
        contentEl.innerHTML = html && html.trim() !== '' ? html : '<p><em>暂无内容</em></p>';

        statusEl.textContent = '已加载';
      } catch (err) {
        console.error(err);
        contentEl.innerHTML =
          '<div class="error">加载失败：' + (err?.message || '未知错误') +
          '<br>提示：若在本地 file:// 打开，浏览器可能因 CORS 限制无法读取远程文件。请使用本地服务器或部署到站点。</div>';
        statusEl.textContent = '加载失败';
      }
    }

    // 提及次数：读取每行“名称 称号”，展示列表
    async function fetchMentions(url) {
      const statusEl = document.getElementById('statusText');
      const contentEl = document.getElementById('mentionsContent');

      statusEl.textContent = '正在加载...';
      contentEl.innerHTML = '';

      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('网络响应异常：' + res.status + ' ' + res.statusText);
        let text = await res.text();
        text = text.replace(/\r\n/g, '\n').trim();

        const lines = text.split('\n').map(l => l.trim()).filter(Boolean);

        const items = lines.map(line => {
          const parts = line.split(/\s+/);
          const name = parts[0] || '';
          const title = parts[1] || '';
          return { name, title };
        }).filter(it => it.name);

        if (items.length === 0) {
          contentEl.innerHTML = '<div class="status">暂无数据</div>';
          statusEl.textContent = '已加载';
          return;
        }

        const ul = document.createElement('ul');
        ul.className = 'mentions-list';
        items.forEach(({ name, title }) => {
          const li = document.createElement('li');
          li.className = 'mentions-item';
          const left = document.createElement('span');
          left.className = 'name';
          left.textContent = name;
          const right = document.createElement('span');
          right.className = 'title-badge';
          right.textContent = title;
          li.appendChild(left);
          li.appendChild(right);
          ul.appendChild(li);
        });
        contentEl.appendChild(ul);

        statusEl.textContent = '已加载';
      } catch (err) {
        console.error(err);
        contentEl.innerHTML =
          '<div class="error">加载失败：' + (err?.message || '未知错误') +
          '<br>提示：若在本地 file:// 打开，浏览器可能因 CORS 限制无法读取远程文件。请使用本地服务器或部署到站点。</div>';
        statusEl.textContent = '加载失败';
      }
    }

    // 禁止保存快捷键（Ctrl/Cmd+S）
    function disableSaveShortcut() {
      const handler = (e) => {
        const isMac = navigator.platform.toUpperCase().includes('MAC');
        const key = (e.key || '').toLowerCase();
        const saveCombo = (isMac && e.metaKey && key === 's') || (!isMac && e.ctrlKey && key === 's');
        if (saveCombo) { e.preventDefault(); e.stopPropagation(); }
      };
      window.addEventListener('keydown', handler, { capture: true });
    }

    // 仅阻止 Ctrl/Cmd+C、右键菜单与拖拽（保留选中和链接点击）
    function limitCopyButKeepSelection() {
      // 1) 禁用右键菜单
      document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
      }, { capture: true });

      // 2) 禁用拖拽（避免拖走图片/文本）
      document.addEventListener('dragstart', (e) => {
        e.preventDefault();
      }, { capture: true });

      // 3) 禁用复制快捷键：Ctrl/Cmd + C
      document.addEventListener('keydown', (e) => {
        const isMac = navigator.platform.toUpperCase().includes('MAC');
        const key = (e.key || '').toLowerCase();

        const withCmd = isMac && e.metaKey;
        const withCtrl = !isMac && e.ctrlKey;
        if ((withCmd || withCtrl) && key === 'c') {
          e.preventDefault();
          e.stopPropagation();
        }
      }, { capture: true });

      // 4) 可选：阻止显式复制事件（例如浏览器编辑菜单触发）
      document.addEventListener('copy', (e) => {
        e.preventDefault();
        e.stopPropagation();
      }, { capture: true });
    }

    function init() {
      applyTheme();

      // 绑定 tabs
      document.getElementById('tabHome').addEventListener('click', () => switchView('home'));
      document.getElementById('tabMentions').addEventListener('click', () => switchView('mentions'));

      // 刷新按钮根据当前视图刷新对应数据
      document.getElementById('refreshBtn').addEventListener('click', () => {
        if (currentView === 'home') fetchNews(NEWS_URL);
        else fetchMentions(MENTIONS_URL);
      });

      // 默认打开主页面；如需默认打开提及次数，请换成 switchView('mentions')
      switchView('home');

      // 保护策略：不影响选中与链接点击
      limitCopyButKeepSelection();

      // 保留之前的禁用保存快捷键
      disableSaveShortcut();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>